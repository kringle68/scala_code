-- DCOP-578: Bulk cleanup of transfer pending items
-- See DCOP-462 for investigation details. Basically Andy came up with a way
-- of identifying items in Transfer Pending that shouldn't be there, and this
-- deletes them and logs it. The variant id and shipment_item id restrictions
-- in here are to make sure the BAU doesn't take forever to run on production,
-- while still coping with changes that might have happened between the time
-- we ran the query on the slave to get the list of variant ids and the time
-- the BAU actually gets run.

BEGIN;

insert into log_sample_adjustment (
    sku, location_name, operator_name, channel_id, notes, delta, balance
)
select v.product_id || '-' || sku_padding(v.size_id), l.location, 'Application', q.channel_id,
    'Adjusted by BAU to fix error - DCOP-462', (-1*q.quantity), 0
from quantity q join variant v on v.id=q.variant_id
join location l on q.location_id=l.id
where l.location='Transfer Pending'
and q.variant_id in (
491395, 614701, 642363, 629613, 726832, 620234, 2054059, 2113209, 2083334,
2075863, 1263361, 2134850, 2202640, 2237639, 2218508, 2762308, 2762306, 2231444,
2241250, 2294124, 2293749, 766373, 894177, 908734, 946424, 981496, 985413,
987415, 995003, 1148053, 1194859, 1201423, 1261515, 1317341, 1422252, 1160246,
1159848, 1177932, 1206285, 1211834, 128351, 1434861, 1458858, 1462048, 1462230,
1493918, 811558, 810241, 736228, 817731, 2333118, 3027753, 2329782, 160049,
3083249, 3088392, 3090399, 3090192, 3090318, 3101758, 3094624, 3094832, 3109304,
3151568, 3200727, 3272346, 3283097, 3348605, 3434642, 3404937, 3429254, 3454501,
3428782, 3432797, 3443160, 3445759, 3527854, 3521934, 3556818, 3510487, 3588389,
3559171, 174063, 3556352, 3561538, 3560370, 3687918, 3605423, 3624085, 3653462,
3652763, 3661062, 3719034, 3821068, 3755308, 3704612, 181256, 3813671, 3869580,
3822739, 3737064, 3837778, 3838812, 3742859, 3746595, 3746266, 3746996, 3774079,
3779664, 3822003, 3754512, 3754657, 3893169, 3893301, 3767741, 3868550, 3893660,
3822688, 3826597, 3777541, 3791612, 3782402, 3776698, 3850705, 3781668, 3785200,
3794400, 3851650, 3797524, 3947144, 3804638, 3798761, 3800418, 3804672, 3996066,
3900306, 3812971, 3947398, 3871235, 3831677, 3839708, 3839600, 3863254, 3848096,
3845809, 3847375, 4092612, 3895173, 3881703, 3887798, 3918412, 3996584, 3909011,
3909847, 3980655, 3983847, 3938115, 3943421, 3956879, 3958304, 4077191, 3980642,
3979498, 3988559, 4000513, 4002783, 3999945, 4004114, 3999958, 4083992, 4056202,
4007561, 4078784, 4084388, 4053529, 4061125, 4096216, 4094935, 4063267, 4076521,
4073235, 4073532, 4065558, 4108789, 4073898, 4088335, 4088719, 4088970, 4102525,
4094338, 4337618, 4130347, 4107986, 4110403, 4180343, 4115779, 4128214, 4115560,
4139516, 4123249, 4128418, 4135830, 4152001, 4161887, 4164496, 4168091, 4270304,
4173917, 4195523, 4223933, 4236349, 4245602, 4246174, 4259558, 4254639, 4268639,
4290369, 4287734, 4294309, 4356307, 4311742, 4322156, 4377809, 4374228, 4404834,
4420019, 4438428, 4452721, 4453515, 4495942, 4608046, 4523694, 4522275, 4500722,
4544747, 4544749, 4548164, 221996, 225565, 225569, 4591398, 4603795, 482704,
528809
)
and v.id not in (
    select si.variant_id
    from shipment_item si join shipment s on s.id=si.shipment_id
    join link_stock_transfer__shipment lsts on lsts.shipment_id=s.id
    join stock_transfer st on lsts.stock_transfer_id=st.id
    where si.shipment_item_status_id != 8 -- not Returned
    and si.id > 11000000 -- we can assume nothing has changed with anything older
                        -- than this since the variant id list was built
)
and v.id not in (
    select si.variant_id
    from shipment_item si join shipment s on s.id=si.shipment_id
    join link_stock_transfer__shipment lsts on lsts.shipment_id=s.id
    join stock_transfer st on lsts.stock_transfer_id=st.id
    join return_item ri on ri.shipment_item_id=si.id
    where ri.return_item_status_id != 7 -- not Put Away
    and si.id > 11000000
);

delete from quantity where id in (
select q.id
from quantity q join variant v on v.id=q.variant_id
join location l on q.location_id=l.id
where l.location='Transfer Pending'
and v.id not in (
    select si.variant_id
    from shipment_item si join shipment s on s.id=si.shipment_id
    join link_stock_transfer__shipment lsts on lsts.shipment_id=s.id
    join stock_transfer st on lsts.stock_transfer_id=st.id
    where si.shipment_item_status_id != 8 -- not Returned
    and si.id > 11000000
)
and v.id not in (
    select si.variant_id
    from shipment_item si join shipment s on s.id=si.shipment_id
    join link_stock_transfer__shipment lsts on lsts.shipment_id=s.id
    join stock_transfer st on lsts.stock_transfer_id=st.id
    join return_item ri on ri.shipment_item_id=si.id
    where ri.return_item_status_id != 7 -- not Put Away
    and si.id > 11000000
)
)
and variant_id in (
491395, 614701, 642363, 629613, 726832, 620234, 2054059, 2113209, 2083334,
2075863, 1263361, 2134850, 2202640, 2237639, 2218508, 2762308, 2762306, 2231444,
2241250, 2294124, 2293749, 766373, 894177, 908734, 946424, 981496, 985413,
987415, 995003, 1148053, 1194859, 1201423, 1261515, 1317341, 1422252, 1160246,
1159848, 1177932, 1206285, 1211834, 128351, 1434861, 1458858, 1462048, 1462230,
1493918, 811558, 810241, 736228, 817731, 2333118, 3027753, 2329782, 160049,
3083249, 3088392, 3090399, 3090192, 3090318, 3101758, 3094624, 3094832, 3109304,
3151568, 3200727, 3272346, 3283097, 3348605, 3434642, 3404937, 3429254, 3454501,
3428782, 3432797, 3443160, 3445759, 3527854, 3521934, 3556818, 3510487, 3588389,
3559171, 174063, 3556352, 3561538, 3560370, 3687918, 3605423, 3624085, 3653462,
3652763, 3661062, 3719034, 3821068, 3755308, 3704612, 181256, 3813671, 3869580,
3822739, 3737064, 3837778, 3838812, 3742859, 3746595, 3746266, 3746996, 3774079,
3779664, 3822003, 3754512, 3754657, 3893169, 3893301, 3767741, 3868550, 3893660,
3822688, 3826597, 3777541, 3791612, 3782402, 3776698, 3850705, 3781668, 3785200,
3794400, 3851650, 3797524, 3947144, 3804638, 3798761, 3800418, 3804672, 3996066,
3900306, 3812971, 3947398, 3871235, 3831677, 3839708, 3839600, 3863254, 3848096,
3845809, 3847375, 4092612, 3895173, 3881703, 3887798, 3918412, 3996584, 3909011,
3909847, 3980655, 3983847, 3938115, 3943421, 3956879, 3958304, 4077191, 3980642,
3979498, 3988559, 4000513, 4002783, 3999945, 4004114, 3999958, 4083992, 4056202,
4007561, 4078784, 4084388, 4053529, 4061125, 4096216, 4094935, 4063267, 4076521,
4073235, 4073532, 4065558, 4108789, 4073898, 4088335, 4088719, 4088970, 4102525,
4094338, 4337618, 4130347, 4107986, 4110403, 4180343, 4115779, 4128214, 4115560,
4139516, 4123249, 4128418, 4135830, 4152001, 4161887, 4164496, 4168091, 4270304,
4173917, 4195523, 4223933, 4236349, 4245602, 4246174, 4259558, 4254639, 4268639,
4290369, 4287734, 4294309, 4356307, 4311742, 4322156, 4377809, 4374228, 4404834,
4420019, 4438428, 4452721, 4453515, 4495942, 4608046, 4523694, 4522275, 4500722,
4544747, 4544749, 4548164, 221996, 225565, 225569, 4591398, 4603795, 482704,
528809
);
COMMIT;
