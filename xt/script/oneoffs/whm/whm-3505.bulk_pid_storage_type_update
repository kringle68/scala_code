#!/opt/xt/xt-perl/bin/perl

use NAP::policy qw/tt/;

=head1 NAME

script/oneoffs/whm/whm-3505.bulk_pid_storage_type_update

=head1 DESCRIPTION

This script borrows heavily from a previous script that updated images on IWS
that was written for WHM-667. This ticket states that IWS updates need to be
throttled so I have included this faeture of the previous script too.

This script receives a file of PIDs from IWS that contains PID numbers of
products that must have their storage type set to 'Oversized' for the new DC1
GOH implementation. The script sends pid_update messages to IWS in order to
update their storage type status.

The script will only update those products that actually exist on the
xtracker database

=head1 SYNOPSIS

  This script must be provided with the location of the file of PIDs
  provided by IWS. There are two optional flags: -v, for verbose output and
  -d, for a dry run, for example:

  perl script/oneoffs/whm/whm-3505.bulk_pid_storage_type_update --pidfile /home/iws_pids.csv -v

  You can also specify a throttling value, like:

  perl script/oneoffs/whm/whm-3505.bulk_pid_storage_type_update --throttle 10/1000

  This will send 1000 products, then sleep for 10 seconds.

If a product can't be updated, the exception will be printed to STDERR.

=cut

use Pod::Usage;

use XTracker::Script::Product::WHM3505BulkPidStorageTypeUpdate;
use Getopt::Long;

my %opt;

my $result = GetOptions(
    \%opt,
    'pidfile|p=s',
    'verbose|v',
    'dryrun|d',
    'throttle|t=s',
    'help|h|?',
);

pod2usage(1) if (!$result || $opt{help} || !$opt{pidfile});

XTracker::Script::Product::WHM3505BulkPidStorageTypeUpdate->new->invoke(%opt);
